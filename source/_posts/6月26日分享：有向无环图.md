---
title: 6月26日分享：有向无环图
date: 2018-06-26 20:48:41
tags:
---

Directed Acyclic Graph, DAG

分享者：彦丞

# 概念

> 如果一个有向图从任意顶点出发无法经过若干条边回到该点，则这个图是一个有向无环图。[link to WIKI](https://zh.wikipedia.org/wiki/%E6%9C%89%E5%90%91%E6%97%A0%E7%8E%AF%E5%9B%BE)

1. tree一定是有向无环图
1. 有向无环图未必能转化成tree

## 详细说明

理想化的DAG大概是这么个图（没有所谓的主链）

![](/images/dag1.png)

在区块链的应用上，DAG图的每个顶点代表在某一个时间新挖出的区块。一般的线性区块链是DAG的一种特殊情况，也即每个时间段整个系统只能产生一个区块。不同的是，DAG允许不同节点按自己的节奏生成区块，只要每个区块选择一个或多个区块作为自己的子区块。

# IOTA实现

iota用的tangle结构，就是有个交易确认度的概念
不过由于其共识机制还在发展中，网络不够完善
所以提出了一个coordinator的机制，目前应该也还是中心化的

IOTA在防止双花上采取了不同的策略。IOTA将主链的概念普遍化为扭结（tangle），实际上代表厚度任意的主链。在新顶点产生的时候，每个新顶点会选择2个旧顶点作为父顶点，并进行PoW挖矿。IOTA在确定扭结时，按照所有的父顶点关系进行权重计算，给予较多子顶点支持的父顶点更多的权重。

![](/images/dag2.gif)

# NANO实现

另外提一下nano，以前叫railblocks 采用点阵结构 nano我记得是一个中国人做的，非常独特和优美

Nano采取的DAG架构是给每个账户安排一条单独的链，这些链只有每当有发送或者接受转账时会更新相关交易的信息，这样每条链都只处理跟自己账户有关的交易，大大减少了需要处理的交易总量。

与比特币不同，由于Nano每个账户有单独的链，对未来的交易可以提前进行PoW挖矿。Nano白皮书对于事先提前挖矿的攻击并没有防御措施。

# Byteball实现

byteball本身指定了12个见证人节点
由见证人来确定主链选择

Byteball要求从创始块开始确定一条所有参与者公认的主链，而将其它的顶点看作是附属在这条主链上。每一条主链对应着一种不同的主观上的时间顺序，从而对应着不同的双花交易的确认。另外，为了防止攻击者暗中生成影子链并且链嫁接在主链上，Byteball提出见证人（Witness）制度进行主链选择。每当见证人看到一个顶点，就公开宣布看到过这个顶点，而系统选择主链时就依照选择被见证次数最多的顶点的原则。在这种制度下，只需要保证大多数的见证人不会与攻击者窜通作恶，就可以保证主链选择过程的安全性。

Nano设计成零交易费，所以为了防止垃圾交易，每笔交易入账需要进行一个小算力的PoW挖矿。

## 其他实现

其他的都是已经上市，但是实际上还没推出主网的项目，比如vite，CyberVein，Ambr等等
由于在tps上已经没法再吹牛，新的dag项目主要是宣传安全性，提出新的共识算法，支持智能合约等等

## 攻击

DAG允许多重并行交易的特征，导致攻击者可能暗中生成一条影子链，并且时不时地将影子链跟主链进行对接以逃避检测算法。极端情况下，这条影子链有可能代替主链成为全网的共识。

## 共识算法

DAG的共识算法方面实际上基本都是DAGLabs推出的
早期的比如Inclusive，Spectre
今年出现的Phantom和Avalanche

spectre是支持pow的
另外avalanche应该已经有个项目再发车了，team rocket
snowflake to avalanche，白皮书写的非常棒
Phantom是通过对交易进行排序，实现dag对智能合约高并发的支持方案
avalanche是提出了一套bft+DAG的方案

# 智能合约

一个是Constellation，已经上线测试，应该是使用的交易序列，来支持智能合约的实现，同时其智能合约用的是scala语言。
另外hashgraph还有其他几个用的实际上是offchain的智能合约实现形式，用docker，microservice之类，结合DAG

Vite比较特别的是采用了分组，分级的DAG结构，有所谓共识组，快照组
快照组进行全网的维护和确认，具体的大家可以看vite白皮书

## 总结

所以可以看出来DAG的一个主要尝试方向就是把见证人模式优化成分组分层的结构，通过权重来区别节点以及交易

总的来说DAG结构目前只适合特定方向的应用场景，自身也有非常多的问题需要解决，共识机制也才刚刚开始完善，广阔天地大有可为

## Q & A

### IOTA如何防止垃圾交易拥堵网络？

gossip protocol，降低带宽
又比如hashgraph的gossip of gossip，基本上把带宽降到非常低

### 那么千万级别TPS的区块链是如何实现的

比如EOS，一条主链3000 TPS，我来300个侧链，差不多就百万级。

然后每条链上我还能做multi thread，千万级不在话下

### DAG效率如何优化

DAG与代数拓扑学中被深入研究的偏序集（Partially Ordered Set或Poset）有紧密联系。事实上，任何一个DAG都唯一对应一个Poset, 而所有的Poset都是DAG，所以它们在本质上是一种事物。

比如，网络里路由最重要，路由最主要的作用一个是防止环路，一个是找到最短路径
有了路由，整个网络才能比较优化的处理更大的数据量，更加稳定

放环最主要的几个方法就是指定几个主路由器，然后分层分组，每几个路由节点负责处理本层或者本组的数据。同时网络协议为了降低全网的广播带宽，也做了很多优化，比如分边缘节点，核心节点之类
跟DAG的概念是非常像的

像最新出来的几个项目，Celer，其核心构件最有特色的就是cRoute，大家可以去看看

### IOTA和Nano的容错率是多少？

比如iota，根据交易被确认的次数，来确定交易的确认完成度
如果定义为100次，基本上在数学上就是完全可信的了

nano本身不够完善，之前都是一个人在做的

iota就不说了，他的coordinator实际上还是中心化的
只适合iot场景（量大，低价值，高吞吐，对时延精度要求不高）

### 为什么说IOTA是中心化的？

由于IOTA是为了规模应用而建立的，因此出于安全原因，我们采用了一种自主的和临时性的共识机制：协调器。每隔两分钟，IOTA基金会创建一笔里程碑（milestone）交易，所有经它确认的交易立即被认为具有100％的确认置信度。使用协调器，Alice的第二笔交易就永远不会得到确认。协调器在IOTA网络早期发展阶段充当了一种保护机制，直到完整的Tangle分布式共识算法开始发挥作用时，IOTA基金会将关闭协调器，让Tangle完全依靠自身来演变和发展。这将在迭代阶段发生，当网络成熟到可以摆脱协调员时，网络本身也会立即变得更加效率。

从概率上讲，小微交易差不多确认就行啦
大额交易，可以要求确认置信度到90%以上

这个调节器实际上是在共识不稳定时期做一个防止回滚的功能

